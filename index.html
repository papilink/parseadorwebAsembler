<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ MSX2 ROM Viewer - PAPIWEB</title>
    <!-- JSZip para soporte de archivos ZIP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #00ff41;
            --primary-dark: #00cc34;
            --primary-light: #00ff6a;
            --bg-dark: #0a0e27;
            --bg-darker: #050810;
            --text-light: #e0e6ff;
            --text-secondary: #a0aac0;
            --accent: #ff006e;
            --success: #00d4ff;
            --warning: #ffa500;
        }

        body {
            background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--primary);
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            color: var(--primary);
            text-shadow: 0 0 20px var(--primary);
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .header p {
            color: var(--success);
            font-size: 1em;
            margin-bottom: 10px;
        }

        .header .papiweb {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--primary);
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 8px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(0, 255, 65, 0.2);
            padding-bottom: 10px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: 2px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            transition: all 200ms ease;
        }

        .tab-btn:hover {
            color: var(--primary);
            border-color: rgba(0, 255, 65, 0.3);
        }

        .tab-btn.active {
            color: var(--primary);
            border-color: var(--primary);
            background: rgba(0, 255, 65, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Container Principal */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            grid-auto-rows: min-content;
        }

        /* Controls Panel */
        .control-panel {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 10px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .control-panel h2 {
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 1.4em;
            text-shadow: 0 0 10px var(--primary);
        }

        /* File Input Styling */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 255, 65, 0.1), rgba(0, 212, 255, 0.1));
            border: 2px dashed var(--primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-light);
            font-weight: 500;
        }

        .file-input-label:hover {
            border-color: var(--primary-light);
            background: linear-gradient(135deg, rgba(0, 255, 65, 0.2), rgba(0, 212, 255, 0.2));
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }

        .file-input-label.dragover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(255, 0, 110, 0.2), rgba(255, 165, 0, 0.2));
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.4);
        }

        /* Buttons */
        button {
            width: 100%;
            padding: 15px 20px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: var(--bg-darker);
            box-shadow: 0 5px 20px rgba(0, 255, 65, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: 0 8px 30px rgba(0, 255, 65, 0.5);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: rgba(0, 212, 255, 0.2);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(0, 212, 255, 0.3);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        /* ZIP Block Buttons */
        .zip-block-button {
            padding: 10px 12px;
            background: rgba(0,255,65,0.1);
            border: 1px solid rgba(0,255,65,0.3);
            border-radius: 6px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: monospace;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .zip-block-button:hover {
            background: rgba(0,255,65,0.2);
            border-color: var(--primary);
            box-shadow: 0 0 15px rgba(0,255,65,0.2);
            transform: translateX(2px);
        }

        .zip-block-button.selected {
            background: rgba(0,255,65,0.3);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(0,255,65,0.4);
            font-weight: bold;
            color: var(--primary);
        }

        .zip-block-info {
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-right: auto;
        }

        .zip-block-size {
            background: rgba(0,255,65,0.2);
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: bold;
            color: var(--primary);
        }

        /* Info Panel */
        .info-panel {
            background: rgba(0, 0, 0, 0.4);
            border-left: 3px solid var(--success);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .info-title {
            color: var(--success);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .info-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .info-content .label {
            color: var(--text-light);
            display: inline-block;
            width: 100px;
        }

        /* Canvas Area */
        .canvas-wrapper {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .canvas-wrapper h2 {
            color: var(--primary);
            margin-bottom: 20px;
            align-self: flex-start;
            font-size: 1.2em;
        }

        canvas {
            border: 1px solid var(--primary);
            border-radius: 8px;
            background: #000;
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
            max-width: 100%;
            height: auto;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* Status Indicators */
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.95em;
        }

        .status.loading {
            background: rgba(255, 165, 0, 0.1);
            color: var(--warning);
            border-left: 3px solid var(--warning);
        }

        .status.success {
            background: rgba(0, 255, 65, 0.1);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }

        .status.error {
            background: rgba(255, 0, 110, 0.1);
            color: var(--accent);
            border-left: 3px solid var(--accent);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status.loading .status-dot {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }

        .status.success .status-dot {
            background: var(--primary);
        }

        .status.error .status-dot {
            background: var(--accent);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        /* Canvas Placeholder */
        .canvas-placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 40px;
        }

        .canvas-placeholder p {
            margin: 10px 0;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: var(--text-secondary);
            border-top: 1px solid rgba(0, 255, 65, 0.2);
            font-size: 0.9em;
        }

        .footer strong {
            color: var(--primary);
        }

        /* Loading Animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(0, 255, 65, 0.3);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Emulator thumbnail & fullscreen */
        .emulator-thumbnail {
            width: 256px;
            height: 212px;
            border: 2px solid rgba(255,255,255,0.06);
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 18px rgba(0,0,0,0.6);
            background: #000;
            image-rendering: pixelated;
        }

        .emulator-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 12px;
        }

        .fs-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .fs-overlay canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
            box-shadow: 0 10px 60px rgba(0,0,0,0.8);
        }

        .fs-close {
            position: fixed;
            top: 18px;
            right: 18px;
            z-index: 10000;
        }

        .fs-controls {
            position: fixed;
            left: 18px;
            bottom: 18px;
            z-index: 10000;
            display: flex;
            gap: 8px;
            align-items: center;
            background: rgba(0,0,0,0.4);
            padding: 8px 10px;
            border-radius: 8px;
            backdrop-filter: blur(6px);
        }

        .fs-controls input[type="range"] {
            width: 160px;
        }

        /* Advanced options */
        .advanced-options {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.2);
            border-radius: 6px;
        }

        .advanced-options-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .advanced-options-content {
            display: none;
        }

        .advanced-options-content.active {
            display: block;
        }

        .adv-group {
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .adv-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .adv-input-group label {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .adv-input-group input {
            padding: 6px 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 65, 0.3);
            color: var(--text-light);
            border-radius: 4px;
            font-family: monospace;
            width: 140px;
        }

        .adv-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .adv-presets button {
            padding: 6px 10px;
            font-size: 0.85em;
        }

        /* Grid responsivo */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üéÆ MSX2 ROM VIEWER</h1>
        <p>‚ú® WebAssembly Sprite Processor</p>
        <div class="papiweb">
            ¬© 2026 PAPIWEB DESARROLLOS INFORMATICOS
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-container">
        <button class="tab-btn active" data-tab="processor" onclick="switchTab(event, 'processor')">
            üî¨ Procesador de Sprites
        </button>
        <button class="tab-btn" data-tab="emulator" onclick="switchTab(event, 'emulator')">
            üéÆ Emulador Funcional
        </button>
    </div>

    <!-- Processor Tab -->
    <div id="processor" class="tab-content active">
        <!-- Main Container -->
        <div class="container">
        <!-- Control Panel -->
        <div class="control-panel">
            <h2>üìÅ Cargar ROM</h2>

            <!-- File Input -->
            <div class="file-input-wrapper">
                <input 
                    type="file" 
                    id="fileInput" 
                    accept=".rom,.bin,.dat" 
                    aria-label="Cargar archivo ROM"
                >
                <label for="fileInput" class="file-input-label" id="fileLabel">
                    <span>üìÇ Selecciona o arrastra tu archivo .rom</span>
                </label>
            </div>

            <!-- File Info -->
            <div id="fileInfo" class="info-panel" style="display: none;">
                <div class="info-title">üìã Informaci√≥n del Archivo</div>
                <div class="info-content">
                    <div><span class="label">Nombre:</span> <span id="fileName">-</span></div>
                    <div><span class="label">Tama√±o:</span> <span id="fileSize">-</span></div>
                    <div><span class="label">Tipo:</span> <span id="fileType">-</span></div>
                </div>
            </div>

            <!-- Status -->
            <div id="status" style="display: none;"></div>

            <!-- Process Buttons -->
            <button id="processBtn" class="btn-primary" disabled>
                ‚ö° PROCESAR RGBA
            </button>

            <button id="processFullBtn" class="btn-primary" disabled>
                üåü PROCESAMIENTO COMPLETO
            </button>

            <button id="clearBtn" class="btn-secondary" style="display: none;">
                üóëÔ∏è Limpiar
            </button>

            <!-- Analysis Panel -->
            <div id="analysisPanel" class="info-panel" style="display: none; margin-top: 20px;">
                <div class="info-title">üìä An√°lisis</div>
                <div class="info-content">
                    <div><span class="label">Bytes:</span> <span id="bytesCount">0</span></div>
                    <div><span class="label">P√≠xeles:</span> <span id="pixelCount">0</span></div>
                    <div><span class="label">Resoluci√≥n:</span> <span id="resolution">256√ó212</span></div>
                    <div><span class="label">Tiempo:</span> <span id="processTime">-</span></div>
                </div>
            </div>

            <!-- ZIP Blocks Selector Panel -->
            <div id="zipBlocksPanel" class="info-panel" style="display: none; margin-top: 20px;">
                <div class="info-title">üì¶ Archivos en ZIP</div>
                <div class="info-content">
                    <div style="font-size: 0.85em; margin-bottom: 12px;">
                        <strong style="color: var(--primary);">Se detect√≥ archivo ZIP con m√∫ltiples bloques.</strong>
                        <p style="color: var(--text-secondary); margin-top: 8px;">Selecciona el bloque/archivo a cargar:</p>
                    </div>
                    <div id="zipBlocksList" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Bloques se generan din√°micamente aqu√≠ -->
                    </div>
                </div>
            </div>

            <!-- Memory Map Panel -->
            <div class="info-panel" style="display: none; margin-top: 20px;" id="memoryPanel">
                <div class="info-title">üó∫Ô∏è Mapa de Memoria MSX2</div>
                <div class="info-content" style="font-size: 0.85em; font-family: monospace;">
                    <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-bottom: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <div style="color: var(--primary);">0x0000-0x3FFF</div>
                            <div style="color: var(--text-secondary);">BIOS/ROM (Slot 0)</div>
                            <div style="color: var(--primary);">0x4000-0x7FFF</div>
                            <div style="color: var(--text-secondary);">Cartridge (Slot 1)</div>
                            <div style="color: var(--primary);">0x8000-0xBFFF</div>
                            <div style="color: var(--text-secondary);">RAM (Slot 2)</div>
                            <div style="color: var(--primary);">0xC000-0xFFFF</div>
                            <div style="color: var(--text-secondary);">RAM Principal (Slot 3)</div>
                        </div>
                    </div>
                </div>
                
                <!-- Load Address Selector -->
                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,255,65,0.2);">
                    <label style="display: block; margin-bottom: 8px; color: var(--primary); font-weight: 500; font-size: 0.9em;">Direcci√≥n de Carga:</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="window.setMemoryAddress(0xC000)" style="padding: 6px 12px; font-size: 0.85em;">0xC000 (Est√°ndar)</button>
                        <button class="btn-secondary" onclick="window.setMemoryAddress(0x4000)" style="padding: 6px 12px; font-size: 0.85em;">0x4000 (Slot 1)</button>
                        <button class="btn-secondary" onclick="window.setMemoryAddress(0x8000)" style="padding: 6px 12px; font-size: 0.85em;">0x8000 (Slot 2)</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label style="display: block; font-size: 0.8em; color: var(--text-secondary); margin-bottom: 4px;">Direcci√≥n personalizada (hex):</label>
                            <input type="text" id="customLoadAddress" placeholder="ej: 0xC000" style="width: 100%; padding: 6px 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,65,0.3); color: var(--text-light); border-radius: 4px; font-family: monospace; font-size: 0.85em;">
                        </div>
                        <button class="btn-secondary" onclick="window.applyCustomAddress()" style="padding: 6px 12px; font-size: 0.85em; white-space: nowrap;">Aplicar</button>
                    </div>
                </div>
                
                <!-- Load Info Display -->
                <div id="loadInfo" style="display: none; margin-top: 12px; padding: 10px; background: rgba(0,255,65,0.1); border: 1px solid rgba(0,255,65,0.3); border-radius: 4px;">
                    <div style="font-size: 0.8em; color: var(--primary); margin-bottom: 6px; font-weight: bold;">üìç Informaci√≥n de Carga</div>
                    <div><span style="color: var(--primary);">Direcci√≥n:</span> <span id="loadAddress" style="color: var(--text-light); font-weight: bold;">-</span></div>
                    <div><span style="color: var(--primary);">Tama√±o Binary:</span> <span id="loadSize" style="color: var(--text-light); font-weight: bold;">-</span></div>
                    <div><span style="color: var(--primary);">Direcci√≥n Fin:</span> <span id="loadEndAddress" style="color: var(--text-light); font-weight: bold;">-</span></div>
                    <div><span style="color: var(--primary);">Slot:</span> <span id="loadSlot" style="color: var(--success); font-weight: bold;">-</span></div>
                </div>
            </div>

            <!-- BIOS Management Panel -->
            <div class="info-panel" style="margin-top: 20px;">
                <div class="info-title">üíæ Gesti√≥n BIOS MSX2</div>
                <div class="info-content">
                    <!-- File Input for BIOS -->
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--primary); font-weight: 500; font-size: 0.9em;">Cargar BIOS:</label>
                        <div class="file-input-wrapper">
                            <input 
                                type="file" 
                                id="biosInput" 
                                accept=".rom,.bin,.dat" 
                                aria-label="Cargar archivo BIOS"
                            >
                            <label for="biosInput" class="file-input-label" style="margin: 0;">
                                <span>üìÇ Selecciona archivo BIOS (8KB-64KB)</span>
                            </label>
                        </div>
                    </div>

                    <!-- BIOS Load Button -->
                    <button id="loadBiosBtn" class="btn-primary" disabled style="width: 100%; margin-bottom: 12px;">
                        üíæ CARGAR BIOS
                    </button>

                    <!-- BIOS Status -->
                    <div id="biosStatus" style="display: none; margin-bottom: 12px; padding: 8px; border-radius: 4px; font-size: 0.9em;"></div>

                    <!-- BIOS Information Display -->
                    <div id="biosInfo" style="display: none; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; border-left: 3px solid var(--success); margin-bottom: 12px; font-size: 0.85em;">
                        <div style="color: var(--primary); font-weight: bold; margin-bottom: 8px;">‚úÖ BIOS Cargado</div>
                        <div><span style="color: var(--text-secondary);">Archivo:</span> <span style="color: var(--text-light);" id="biosName">-</span></div>
                        <div><span style="color: var(--text-secondary);">Tama√±o:</span> <span style="color: var(--text-light);" id="biosSize">-</span></div>
                        <div><span style="color: var(--text-secondary);">Tipo:</span> <span style="color: var(--text-light);" id="biosType">-</span></div>
                        <div><span style="color: var(--text-secondary);">Checksum:</span> <span style="color: var(--primary); font-family: monospace;" id="biosChecksum">-</span></div>
                        <button id="unloadBiosBtn" class="btn-secondary" style="width: 100%; margin-top: 10px; padding: 6px 12px; font-size: 0.85em;">
                            üóëÔ∏è Descargar BIOS
                        </button>
                    </div>

                    <!-- BIOS Help Text -->
                    <div style="background: rgba(0,255,65,0.05); border: 1px solid rgba(0,255,65,0.2); border-radius: 4px; padding: 8px; font-size: 0.8em; color: var(--text-secondary); line-height: 1.5;">
                        <div style="color: var(--success); font-weight: bold; margin-bottom: 4px;">‚ÑπÔ∏è Archivos BIOS Soportados</div>
                        <div>‚Ä¢ <strong>msxbios.rom</strong> - BIOS principal (16-32 KB)</div>
                        <div>‚Ä¢ <strong>msx2bios.rom</strong> - Extensi√≥n MSX2 (16-32 KB)</div>
                        <div>‚Ä¢ <strong>msx2ext.rom</strong> - Extensi√≥n adicional (16 KB)</div>
                        <div>‚Ä¢ <strong>basic.rom</strong> - Int√©rprete BASIC (32 KB)</div>
                        <div style="margin-top: 4px; color: var(--text-secondary); font-size: 0.75em;">Tama√±os v√°lidos: 8KB, 16KB, 32KB, 64KB</div>
                    </div>
                </div>

            <!-- Advanced Options Panel -->
            <div class="advanced-options" style="display: none;" id="advancedPanel">
                <div class="advanced-options-toggle" id="advToggle">
                    <span>‚öôÔ∏è Opciones Avanzadas</span>
                    <span id="advToggleIcon">‚ñº</span>
                </div>
                <div class="advanced-options-content" id="advContent">
                    <div class="adv-group">
                        <div class="adv-input-group">
                            <label>Offset (bytes):</label>
                            <input type="number" id="romOffset" value="0" min="0">
                        </div>
                        <div class="adv-input-group">
                            <label>Tama√±o (bytes):</label>
                            <input type="number" id="romSize" value="27136" min="1">
                        </div>
                    </div>
                    <div class="adv-group">
                        <label style="font-weight: bold; color: var(--text-secondary); margin-bottom: 6px; width: 100%;">Presets:</label>
                        <div class="adv-presets">
                            <button class="btn-secondary" onclick="window.setRomPreset(0, 27136)">256√ó212</button>
                            <button class="btn-secondary" onclick="window.setRomPreset(0, 32768)">32 KB</button>
                            <button class="btn-secondary" onclick="window.setRomPreset(0, 65536)">64 KB</button>
                            <button class="btn-secondary" onclick="window.setRomPreset(16384, 27136)">+16KB offset</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mode Selection -->
            <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid rgba(0, 255, 65, 0.2);">
                <h3 style="color: var(--success); margin-bottom: 15px; font-size: 0.95em;">‚öôÔ∏è Opciones</h3>
                
                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0; cursor: pointer; color: var(--text-light);">
                    <input type="checkbox" id="enableBilinear" checked>
                    <span>Interpolaci√≥n Bilineal (4K)</span>
                </label>

                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0; cursor: pointer; color: var(--text-light);">
                    <input type="checkbox" id="enableNormals">
                    <span>Normal Maps</span>
                </label>

                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0; cursor: pointer; color: var(--text-light);">
                    <input type="checkbox" id="enableEdges">
                    <span>Detecci√≥n Sobel</span>
                </label>

                <label style="display: flex; align-items: center; gap: 10px; margin: 10px 0; cursor: pointer; color: var(--text-light);">
                    <span>Intensidad Glow:</span>
                    <input type="range" id="glowIntensity" min="0" max="3" step="0.1" value="1.5" style="flex: 1; margin-left: 10px;">
                    <span id="glowValue" style="width: 30px; text-align: right; color: var(--primary);">1.5</span>
                </label>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-wrapper">
            <h2>üñºÔ∏è Vista Previa</h2>
            <div id="canvasContainer" style="width: 100%; display: flex; justify-content: center;">
                <div class="canvas-placeholder">
                    <p>üìÇ Carga un archivo ROM</p>
                    <p style="font-size: 0.85em; margin-top: 10px; color: var(--text-secondary);">
                        o arrastra un archivo .rom aqu√≠
                    </p>
                </div>
            </div>
        </div>
        </div>
    </div>
    <!-- End Processor Tab -->

    <!-- Emulator Tab -->
    <div id="emulator" class="tab-content">
        <div style="max-width: 1400px; margin: 0 auto; padding: 20px; background: rgba(0, 0, 0, 0.4); border-radius: 10px; border: 2px solid rgba(0, 255, 65, 0.2);">
            <h2 style="margin-bottom: 20px; color: var(--primary);">üéÆ Emulador MSX2 Completo (Z80 + VDP)</h2>
            
            <!-- ROM File Input for Emulator -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold; color: var(--text-light);">
                    üìÅ Cargar ROM para jugar:
                </label>
                <input type="file" id="jsmsx-romInput" accept=".rom,.bin,.cas,.dsk,.zip,.gz" style="padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(0,255,65,0.3); color: var(--text-light); border-radius: 4px; width: 100%; max-width: 400px;">
                <small style="display: block; margin-top: 10px; color: var(--text-secondary);">üíæ Soporta: ROM, BIN, CAS, DSK, ZIP, GZ | Emulador: CPU Z80 + VDP (Yamaha V9938)</small>
            </div>

            <!-- ZIP Blocks Selector Panel for Emulator -->
            <div id="jsmsx-zipBlocksPanel" style="display: none; margin-bottom: 20px; padding: 15px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 65, 0.3); border-radius: 8px;">
                <div style="color: var(--primary); font-weight: 600; margin-bottom: 12px;">üì¶ Archivos en ZIP</div>
                <div style="font-size: 0.85em; color: var(--text-secondary); margin-bottom: 12px;">
                    Se detect√≥ archivo ZIP. Selecciona el ROM a emular:
                </div>
                <div id="jsmsx-zipBlocksList" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- Botones generados din√°micamente -->
                </div>
            </div>

            <!-- Emulator Controls -->
            <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="jsmsx_play()" class="btn-primary">‚ñ∂Ô∏è Iniciar</button>
                <button onclick="jsmsx_pause()" class="btn-primary">‚è∏Ô∏è Pausa</button>
                <button onclick="jsmsx_stop()" class="btn-secondary">‚èπÔ∏è Detener</button>
                <button onclick="jsmsx_reset()" class="btn-secondary">üîÑ Reset</button>
                <label style="display: flex; align-items: center; gap: 8px; color: var(--text-light); cursor: pointer;">
                    <input type="checkbox" id="jsmsx-fullscreen" style="cursor: pointer;">
                    ‚§¢ Pantalla completa
                </label>
            </div>

            <!-- JSMSX Container -->
            <div id="jsmsx-container" style="margin-top: 20px; padding: 20px; background: rgba(0,0,0,0.8); border-radius: 8px; border: 2px solid var(--primary); min-height: 500px;">
                <div id="canvas-container" style="display: flex; justify-content: center; align-items: center; width: 100%; height: 400px; background: #000;">
                    <p style="color: var(--text-secondary); text-align: center;">Cargando emulador... üéÆ</p>
                </div>
            </div>

            <!-- Keyboard hints -->
            <div style="margin-top: 15px; padding: 12px; background: rgba(0,255,65,0.1); border: 1px solid rgba(0,255,65,0.3); border-radius: 6px; font-size: 0.9em; color: var(--text-secondary);">
                <strong>‚å®Ô∏è Controles:</strong>
                <ul style="margin-top: 8px; margin-left: 20px; line-height: 1.6;">
                    <li><strong>Flechas / WASD</strong> = Movimiento</li>
                    <li><strong>SPACE</strong> = Bot√≥n A (acci√≥n)</li>
                    <li><strong>CTRL / Z</strong> = Bot√≥n B</li>
                    <li><strong>ENTER</strong> = START</li>
                    <li><strong>ESC</strong> = Pausa</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- End Emulator Tab -->

    <!-- Footer -->
    <div class="footer">
        <p>
            <strong>üåê WebAssembly</strong> ‚Ä¢ 
            <strong>‚ö° Rust</strong> ‚Ä¢ 
            <strong>üíæ MSX2 Sprites</strong>
        </p>
        <p style="margin-top: 10px;">
            Powered by <strong>PAPIWEB DESARROLLOS INFORMATICOS</strong> ¬© 2026
        </p>
    </div>

    <!-- Tab Switching Logic -->
    <script>
        function switchTab(event, tabName) {
            // Ocultar todos los tabs
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            // Desactivar todos los botones
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Mostrar tab seleccionado
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
    </script>

    <!-- Global Utilities -->
    <script>
        // Funciones globales disponibles para todos los scripts
        window.formatBytes = function(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        };
    </script>

    <!-- WASM Module -->
    <script type="module">
        import init, { MSX2Processor, PostProcessResult } from './pkg/msx2_processor.js';

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INICIALIZACI√ìN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let processor = null;
        let currentRomData = null;
        let currentFileName = '';

        async function initializeWasm() {
            try {
                showStatus('Inicializando WebAssembly...', 'loading');
                await init();
                processor = new MSX2Processor(256, 212);
                showStatus('‚úÖ WASM inicializado correctamente', 'success');
                console.log('‚úÖ WASM cargado exitosamente');
            } catch (err) {
                console.error('‚ùå Error inicializando WASM:', err);
                showStatus('‚ùå Error al inicializar WebAssembly', 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MANEJO DE ARCHIVOS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const fileInput = document.getElementById('fileInput');
        const fileLabel = document.getElementById('fileLabel');

        // Click en input
        fileLabel.addEventListener('click', () => {
            fileInput.click();
        });

        // Seleccionar archivo
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFileSelect(file);
            }
        });

        // Drag and drop
        fileLabel.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileLabel.classList.add('dragover');
        });

        fileLabel.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileLabel.classList.remove('dragover');
        });

        fileLabel.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            fileLabel.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect(files[0]);
            }
        });

        function handleFileSelect(file) {
            currentFileName = file.name;
            const reader = new FileReader();

            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                
                // Detectar si es ZIP (firma magic: 0x504B0304)
                const isZip = data[0] === 0x50 && data[1] === 0x4B && data[2] === 0x03 && data[3] === 0x04;
                
                if (isZip) {
                    console.log('üì¶ Archivo ZIP detectado, procesando bloques...');
                    handleZipFile(file, data);
                } else {
                    currentRomData = data;
                    displayFileInfo(file, currentRomData);
                    enableProcessButtons();
                    hideStatus();
                }
            };

            reader.onerror = () => {
                showStatus('‚ùå Error al leer el archivo', 'error');
            };

            reader.readAsArrayBuffer(file);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MANEJO DE ARCHIVOS ZIP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function handleZipFile(file, zipData) {
            try {
                showStatus('üóúÔ∏è Descomprimiendo ZIP...', 'loading');
                
                const zip = new JSZip();
                await zip.loadAsync(zipData);
                
                const files = [];
                
                // Recolectar todos los archivos del ZIP
                zip.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir) {
                        files.push({
                            name: relativePath,
                            size: zipEntry._data ? zipEntry._data.uncompressedSize : 0,
                            path: relativePath
                        });
                    }
                });
                
                if (files.length === 0) {
                    showStatus('‚ùå No hay archivos en el ZIP', 'error');
                    return;
                }
                
                console.log(`üì¶ ZIP contiene ${files.length} archivo(s):`, files);
                
                // Mostrar panel de selecci√≥n
                displayZipBlocksPanel(file, zip, files);
                showStatus(`‚úÖ ZIP descomprimido: ${files.length} bloque(s)`, 'success');
                hideStatusAfter(3000);
                
            } catch (err) {
                console.error('‚ùå Error descomprimiendo ZIP:', err);
                showStatus(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        function displayZipBlocksPanel(file, zip, files) {
            // Mostrar archivo info
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatBytes(file.size);
            document.getElementById('fileType').textContent = 'application/zip';
            
            // Mostrar panel de bloques
            const blocksPanel = document.getElementById('zipBlocksPanel');
            const blocksList = document.getElementById('zipBlocksList');
            
            blocksList.innerHTML = '';
            
            files.forEach((fileInfo, index) => {
                const btn = document.createElement('button');
                btn.className = 'zip-block-button';
                btn.innerHTML = `
                    <span>üìÑ ${fileInfo.name}</span>
                    <span class="zip-block-size">${formatBytes(fileInfo.size)}</span>
                `;
                
                btn.addEventListener('click', async () => {
                    // Marcar como seleccionado
                    document.querySelectorAll('.zip-block-button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    try {
                        showStatus(`‚è≥ Extrayendo ${fileInfo.name}...`, 'loading');
                        
                        // Extraer el archivo del ZIP
                        const extractedData = await zip.file(fileInfo.path).async('uint8array');
                        currentRomData = extractedData;
                        
                        // Crear informaci√≥n de archivo
                        const fileObj = {
                            name: fileInfo.name,
                            size: extractedData.length,
                            type: 'application/octet-stream'
                        };
                        
                        // Mostrar informaci√≥n
                        displayFileInfo(fileObj, currentRomData);
                        enableProcessButtons();
                        
                        showStatus(`‚úÖ ${fileInfo.name} cargado (${formatBytes(extractedData.length)})`, 'success');
                        hideStatusAfter(2000);
                        
                    } catch (err) {
                        console.error('‚ùå Error extrayendo archivo:', err);
                        showStatus(`‚ùå Error: ${err.message}`, 'error');
                    }
                });
                
                blocksList.appendChild(btn);
            });
            
            blocksPanel.style.display = 'block';
            document.getElementById('analysisPanel').style.display = 'none';
            document.getElementById('memoryPanel').style.display = 'none';
            document.getElementById('loadInfo').style.display = 'none';
            document.getElementById('clearBtn').style.display = 'block';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INFORMACI√ìN DEL ARCHIVO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function displayFileInfo(file, data) {
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatBytes(file.size);
            document.getElementById('fileType').textContent = file.type || 'application/octet-stream';

            document.getElementById('analysisPanel').style.display = 'block';
            document.getElementById('zipBlocksPanel').style.display = 'none';
            document.getElementById('memoryPanel').style.display = 'block';
            document.getElementById('bytesCount').textContent = data.length.toLocaleString();
            document.getElementById('pixelCount').textContent = (data.length * 2).toLocaleString();
            document.getElementById('clearBtn').style.display = 'block';
            
            // Actualizar informaci√≥n de carga
            updateLoadInfo();
            
            // Mostrar panel avanzado si la ROM es mayor al tama√±o esperado
            const advPanel = document.getElementById('advancedPanel');
            if (data.length > 27136) {
                advPanel.style.display = 'block';
                document.getElementById('romSize').value = '27136';
            } else {
                advPanel.style.display = 'none';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PROCESAMIENTO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        document.getElementById('processBtn').addEventListener('click', () => {
            processRomData(false);
        });

        document.getElementById('processFullBtn').addEventListener('click', () => {
            processRomData(true);
        });

        function processRomData(useFull) {
            if (!processor || !currentRomData) {
                showStatus('‚ùå ROM no cargada', 'error');
                return;
            }

            showStatus('Procesando...', 'loading');
            const startTime = performance.now();

            try {
                let rgba;
                
                // Obtener offset y tama√±o de opciones avanzadas
                const romOffset = parseInt(document.getElementById('romOffset').value) || 0;
                const romSize = parseInt(document.getElementById('romSize').value) || 27136;

                // Extraer buffer de ROM con offset y tama√±o personalizados
                const endIdx = Math.min(romOffset + romSize, currentRomData.length);
                let romBuffer = currentRomData.slice(romOffset, endIdx);

                if (romBuffer.length < 27136) {
                    console.warn(`‚ö†Ô∏è Buffer insuficiente: ${romBuffer.length} bytes (esperado 27136). Se rellenar√° con ceros.`);
                    // Rellenar con ceros si es necesario
                    const padded = new Uint8Array(27136);
                    padded.set(romBuffer);
                    romBuffer = padded;
                } else if (romBuffer.length > 27136) {
                    console.warn(`‚ö†Ô∏è Buffer mayor al esperado: ${romBuffer.length} bytes. Usando primeros 27136 bytes.`);
                    romBuffer = romBuffer.slice(0, 27136);
                }

                console.log(`üìÇ ROM: offset=${romOffset}, size=${romSize}, buffer=${romBuffer.length} bytes`);

                if (useFull) {
                    // Procesamiento completo con opciones
                    const enableBilinear = document.getElementById('enableBilinear').checked;
                    const enableNormals = document.getElementById('enableNormals').checked;
                    const enableEdges = document.getElementById('enableEdges').checked;
                    const glowIntensity = parseFloat(document.getElementById('glowIntensity').value);

                    const result = processor.process_with_post_effects(
                        romBuffer,
                        enableBilinear,
                        enableNormals,
                        enableEdges,
                        glowIntensity
                    );

                    rgba = result.get_rgba();

                    // Log de informaci√≥n
                    console.log('üìä Procesamiento Completo:');
                    console.log('  RGBA:', rgba.length, 'bytes');
                    console.log('  Normals:', result.get_normals().length, 'bytes');
                    console.log('  Edges:', result.get_edges().length, 'valores');
                } else {
                    // Solo RGBA conversion
                    rgba = processor.transform_to_rgba(romBuffer);
                    console.log('üìä Conversi√≥n RGBA: ', rgba.length, 'bytes');
                }

                // Renderizar en canvas
                renderToCanvas(rgba);

                const endTime = performance.now();
                const processingTime = (endTime - startTime).toFixed(2);

                document.getElementById('processTime').textContent = processingTime + 'ms';
                showStatus(`‚úÖ Procesado en ${processingTime}ms`, 'success');
                hideStatusAfter(3000);

            } catch (err) {
                console.error('‚ùå Error procesando:', err);
                showStatus(`‚ùå Error: ${err.message}`, 'error');
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDERIZADO EN CANVAS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function renderToCanvas(rgbaData) {
            const canvasContainer = document.getElementById('canvasContainer');
            canvasContainer.innerHTML = '';

            const enableBilinear = document.getElementById('enableBilinear').checked;
            const width = enableBilinear ? 3840 : 256;
            const height = enableBilinear ? 2160 : 212;

            // Canvas principal (off-DOM) con resoluci√≥n real
            const mainCanvas = document.createElement('canvas');
            mainCanvas.width = width;
            mainCanvas.height = height;
            const mainCtx = mainCanvas.getContext('2d');
            const imageData = mainCtx.createImageData(width, height);
            const expectedLen = width * height * 4;
            if (rgbaData.length !== expectedLen) {
                console.warn(`‚ö†Ô∏è Tama√±o RGBA inesperado: obtenido ${rgbaData.length}, esperado ${expectedLen}`);
            }

            // Asegurar tipo adecuado para putImageData
            let pixelArray;
            try {
                if (rgbaData instanceof Uint8ClampedArray) {
                    pixelArray = rgbaData;
                } else {
                    pixelArray = new Uint8ClampedArray(rgbaData.buffer || rgbaData);
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è No se pudo convertir a Uint8ClampedArray, creando copia:', e);
                pixelArray = new Uint8ClampedArray(rgbaData);
            }

            // Mostrar primeros p√≠xeles para diagn√≥stico
            const sample = Array.from(pixelArray.slice(0, 16));
            console.log('üîé Muestra RGBA primeros bytes:', sample);

            imageData.data.set(pixelArray.subarray(0, imageData.data.length));
            mainCtx.putImageData(imageData, 0, 0);

            // Miniatura para la UI
            const thumbW = 256;
            const thumbH = 212;
            const thumbCanvas = document.createElement('canvas');
            thumbCanvas.width = thumbW;
            thumbCanvas.height = thumbH;
            thumbCanvas.className = 'emulator-thumbnail';
            const thumbCtx = thumbCanvas.getContext('2d');
            // Configurar suavizado seg√∫n si se est√° usando bilinear
            const smoothing = document.getElementById('enableBilinear').checked;
            thumbCtx.imageSmoothingEnabled = !!smoothing;
            thumbCanvas.style.imageRendering = smoothing ? 'auto' : 'pixelated';
            // Escalar desde el canvas principal
            thumbCtx.drawImage(mainCanvas, 0, 0, width, height, 0, 0, thumbW, thumbH);

            // Controles (fullscreen)
            const controls = document.createElement('div');
            controls.className = 'emulator-controls';
            const fsBtn = document.createElement('button');
            fsBtn.className = 'btn-primary';
            fsBtn.textContent = '‚§¢ Pantalla completa';
            fsBtn.addEventListener('click', () => openFullscreen(mainCanvas));

            // Click en miniatura tambi√©n abre fullscreen
            thumbCanvas.addEventListener('click', () => openFullscreen(mainCanvas));

            controls.appendChild(fsBtn);

            // A√±adir a DOM: miniatura + controles
            const wrapper = document.createElement('div');
            wrapper.style.display = 'flex';
            wrapper.style.alignItems = 'center';
            wrapper.appendChild(thumbCanvas);
            wrapper.appendChild(controls);

            canvasContainer.appendChild(wrapper);

            console.log(`üñºÔ∏è Canvas renderizado (miniatura): ${thumbW}√ó${thumbH} ‚Äî fuente ${width}√ó${height}`);
        }

        function openFullscreen(sourceCanvas) {
            // Crear overlay
            let fsOverlay = document.getElementById('fsOverlay');
            if (!fsOverlay) {
                fsOverlay = document.createElement('div');
                fsOverlay.id = 'fsOverlay';
                fsOverlay.className = 'fs-overlay';
                document.body.appendChild(fsOverlay);
            }
            fsOverlay.innerHTML = '';

            // Canvas para pantalla completa (dibujar copia)
            const fsCanvas = document.createElement('canvas');
            fsCanvas.width = sourceCanvas.width;
            fsCanvas.height = sourceCanvas.height;
            fsCanvas.style.transition = 'transform 120ms ease';
            fsCanvas.style.transformOrigin = 'center center';
            const fsCtx = fsCanvas.getContext('2d');
            const smoothingFs = document.getElementById('enableBilinear').checked;
            fsCtx.imageSmoothingEnabled = !!smoothingFs;
            fsCanvas.style.imageRendering = smoothingFs ? 'auto' : 'pixelated';
            fsCtx.drawImage(sourceCanvas, 0, 0);

            // Bot√≥n cerrar
            const closeBtn = document.createElement('button');
            closeBtn.className = 'fs-close btn-secondary';
            closeBtn.textContent = '‚úñ';

            // Controles de zoom / fit
            const controls = document.createElement('div');
            controls.className = 'fs-controls';

            const zoomOut = document.createElement('button');
            zoomOut.className = 'btn-secondary';
            zoomOut.textContent = '‚àí';

            const zoomIn = document.createElement('button');
            zoomIn.className = 'btn-secondary';
            zoomIn.textContent = '+';

            const fitBtn = document.createElement('button');
            fitBtn.className = 'btn-primary';
            fitBtn.textContent = 'Ajustar';

            const range = document.createElement('input');
            range.type = 'range';
            range.min = '0.1';
            range.max = '4';
            range.step = '0.05';
            range.value = '1';

            controls.appendChild(zoomOut);
            controls.appendChild(range);
            controls.appendChild(zoomIn);
            controls.appendChild(fitBtn);

            // Append elements
            fsOverlay.appendChild(fsCanvas);
            fsOverlay.appendChild(closeBtn);
            fsOverlay.appendChild(controls);

            // Estado de escala
            let scale = 1;
            let lastFit = false;

            function applyScale() {
                fsCanvas.style.transform = `scale(${scale})`;
            }

            function fitToScreen() {
                const margin = 40; // px
                const availableW = window.innerWidth - margin * 2;
                const availableH = window.innerHeight - margin * 2;
                const s = Math.min(availableW / fsCanvas.width, availableH / fsCanvas.height, 1);
                return s || 1;
            }

            zoomIn.addEventListener('click', () => {
                lastFit = false;
                scale = Math.min(4, parseFloat((scale + 0.1).toFixed(2)));
                range.value = String(scale);
                applyScale();
            });

            zoomOut.addEventListener('click', () => {
                lastFit = false;
                scale = Math.max(0.1, parseFloat((scale - 0.1).toFixed(2)));
                range.value = String(scale);
                applyScale();
            });

            range.addEventListener('input', (e) => {
                lastFit = false;
                scale = parseFloat(e.target.value);
                applyScale();
            });

            fitBtn.addEventListener('click', () => {
                scale = fitToScreen();
                range.value = String(scale);
                lastFit = true;
                applyScale();
            });

            // cerrar overlay
            const removeOverlay = () => {
                window.removeEventListener('resize', onResize);
                window.removeEventListener('keydown', onKeyDown);
                if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
                fsOverlay.remove();
            };

            closeBtn.addEventListener('click', removeOverlay);

            // si se ajust√≥ al tama√±o, recalcular cuando cambie la ventana
            function onResize() {
                if (lastFit) {
                    scale = fitToScreen();
                    range.value = String(scale);
                    applyScale();
                }
            }

            window.addEventListener('resize', onResize);

            // Atajos de teclado: +/- para zoom, f para fit, Esc para cerrar
            function onKeyDown(e) {
                const overlayExists = document.getElementById('fsOverlay');
                if (!overlayExists) return;

                const k = e.key;
                const code = e.code || '';

                // Plus: '+' key or '=' or NumpadAdd
                if (k === '+' || k === '=' || code === 'NumpadAdd') {
                    e.preventDefault();
                    lastFit = false;
                    scale = Math.min(4, parseFloat((scale + 0.1).toFixed(2)));
                    range.value = String(scale);
                    applyScale();
                    return;
                }

                // Minus
                if (k === '-' || k === '_' || code === 'NumpadSubtract') {
                    e.preventDefault();
                    lastFit = false;
                    scale = Math.max(0.1, parseFloat((scale - 0.1).toFixed(2)));
                    range.value = String(scale);
                    applyScale();
                    return;
                }

                // Fit
                if (k && k.toLowerCase() === 'f') {
                    e.preventDefault();
                    scale = fitToScreen();
                    range.value = String(scale);
                    lastFit = true;
                    applyScale();
                    return;
                }

                // Escape: cerrar overlay
                if (k === 'Escape') {
                    e.preventDefault();
                    removeOverlay();
                    return;
                }
            }

            window.addEventListener('keydown', onKeyDown);

            // Intentar entrar en fullscreen en el canvas
            fsCanvas.requestFullscreen && fsCanvas.requestFullscreen().catch(()=>{});

            // Aplicar escala inicial (fit si canvas excede viewport)
            if (fsCanvas.width > window.innerWidth || fsCanvas.height > window.innerHeight) {
                scale = fitToScreen();
                range.value = String(scale);
                lastFit = true;
            }
            applyScale();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILIDADES DE UI
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        function enableProcessButtons() {
            document.getElementById('processBtn').disabled = false;
            document.getElementById('processFullBtn').disabled = false;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = `
                <div class="status ${type}">
                    <span class="status-dot"></span>
                    <span>${message}</span>
                </div>
            `;
            statusEl.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        function hideStatusAfter(ms) {
            setTimeout(hideStatus, ms);
        }

        document.getElementById('glowIntensity').addEventListener('input', (e) => {
            document.getElementById('glowValue').textContent = e.target.value;
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GESTI√ìN DE ARCHIVOS BIOS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let currentBiosData = null;
        let currentBiosInfo = null;

        const biosInput = document.getElementById('biosInput');
        const loadBiosBtn = document.getElementById('loadBiosBtn');
        const unloadBiosBtn = document.getElementById('unloadBiosBtn');

        // Usuario selecciona archivo BIOS
        biosInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleBiosFileSelect(file);
            }
        });

        // Habilitar bot√≥n cuando hay archivo
        function handleBiosFileSelect(file) {
            const validSizes = [0x2000, 0x4000, 0x8000, 0x10000];  // 8KB, 16KB, 32KB, 64KB
            
            if (!validSizes.includes(file.size)) {
                showBiosStatus(`‚ùå Tama√±o inv√°lido: ${Math.round(file.size / 1024)}KB. V√°lidos: 8KB, 16KB, 32KB, 64KB`, 'error');
                loadBiosBtn.disabled = true;
                return;
            }
            
            showBiosStatus(`üìÇ Archivo seleccionado: ${file.name} (${Math.round(file.size / 1024)}KB)`, 'success');
            loadBiosBtn.disabled = false;
        }

        // Cargar BIOS en la memoria del procesador
        loadBiosBtn.addEventListener('click', async () => {
            const file = biosInput.files[0];
            if (!file) return;

            try {
                showBiosStatus('‚è≥ Cargando BIOS...', 'loading');
                
                const arrayBuffer = await file.arrayBuffer();
                const biosData = new Uint8Array(arrayBuffer);
                
                // Convertir a array para pasar a Rust
                const biosArray = Array.from(biosData);
                
                // Llamar funci√≥n Rust para cargar BIOS
                const result = processor.load_bios(biosArray, file.name, 'auto');
                
                console.log('‚úÖ Resultado de carga BIOS:', result);
                
                // Obtener informaci√≥n del BIOS cargado
                const biosInfoJson = processor.get_current_bios_info();
                const biosInfo = JSON.parse(biosInfoJson);
                
                if (biosInfo.loaded) {
                    currentBiosData = biosData;
                    currentBiosInfo = biosInfo;
                    
                    // Mostrar informaci√≥n en la interfaz
                    displayBiosInfo(biosInfo);
                    showBiosStatus('‚úÖ ' + result, 'success');
                    
                    // Log detallado
                    const description = processor.get_bios_description();
                    console.log(description);
                    
                    // Deshabilitar input, habilitar descarga
                    loadBiosBtn.disabled = true;
                    unloadBiosBtn.style.display = 'block';
                    biosInput.disabled = true;
                } else {
                    showBiosStatus('‚ùå Error al cargar BIOS', 'error');
                    loadBiosBtn.disabled = true;
                }
            } catch (err) {
                console.error('‚ùå Error:', err);
                showBiosStatus(`‚ùå Error: ${err.message}`, 'error');
                loadBiosBtn.disabled = true;
            }
        });

        // Descargar BIOS
        unloadBiosBtn.addEventListener('click', () => {
            try {
                const result = processor.unload_bios();
                console.log(result);
                
                currentBiosData = null;
                currentBiosInfo = null;
                
                // Ocultar informaci√≥n
                document.getElementById('biosInfo').style.display = 'none';
                document.getElementById('biosStatus').style.display = 'none';
                
                // Limpiar input, habilitar carga
                biosInput.value = '';
                biosInput.disabled = false;
                loadBiosBtn.disabled = true;
                unloadBiosBtn.style.display = 'none';
                
                showBiosStatus(result, 'success');
                hideStatusAfter(3000);
            } catch (err) {
                console.error('‚ùå Error descargando BIOS:', err);
                showBiosStatus(`‚ùå Error: ${err.message}`, 'error');
            }
        });

        // Mostrar informaci√≥n de BIOS en la interfaz
        function displayBiosInfo(biosInfo) {
            const infoPanel = document.getElementById('biosInfo');
            document.getElementById('biosName').textContent = biosInfo.filename;
            document.getElementById('biosSize').textContent = formatBytes(biosInfo.size);
            document.getElementById('biosType').textContent = biosInfo.type;
            document.getElementById('biosChecksum').textContent = biosInfo.checksum;
            infoPanel.style.display = 'block';
        }

        // Mostrar estado BIOS
        function showBiosStatus(message, type) {
            const statusEl = document.getElementById('biosStatus');
            statusEl.innerHTML = `
                <div class="status ${type}">
                    <span class="status-dot"></span>
                    <span>${message}</span>
                </div>
            `;
            statusEl.style.display = 'block';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VARIABLES DE ESTADO DE MEMORIA
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let currentLoadAddress = 0xC000;  // Direcci√≥n de carga por defecto (RAM Principal)
        let memoryMap = {
            'slot0': { address: 0x0000, size: 0x4000, name: 'BIOS/ROM' },
            'slot1': { address: 0x4000, size: 0x4000, name: 'Cartridge' },
            'slot2': { address: 0x8000, size: 0x4000, name: 'RAM (Slot 2)' },
            'slot3': { address: 0xC000, size: 0x4000, name: 'RAM Principal' }
        };

        // Funci√≥n para encontrar slot de memoria
        function findMemorySlot(address) {
            for (let [key, slot] of Object.entries(memoryMap)) {
                if (address >= slot.address && address < (slot.address + slot.size)) {
                    return slot.name + ` (0x${slot.address.toString(16).toUpperCase().padStart(4, '0')})`;
                }
            }
            return 'Desconocido';
        }

        // Funci√≥n para establecer direcci√≥n de memoria
        window.setMemoryAddress = function(address) {
            currentLoadAddress = address;
            const addressHex = '0x' + address.toString(16).toUpperCase().padStart(4, '0');
            document.getElementById('customLoadAddress').value = addressHex;
            console.log(`üìç Direcci√≥n de carga establecida: ${addressHex}`);
            
            // Actualizar informaci√≥n de carga si ROM est√° cargada
            if (currentRomData) {
                updateLoadInfo();
            }
        };

        // Funci√≥n para aplicar direcci√≥n personalizada
        window.applyCustomAddress = function() {
            const input = document.getElementById('customLoadAddress').value.trim();
            let address = currentLoadAddress;
            
            // Parsear entrada hex
            if (input.startsWith('0x') || input.startsWith('0X')) {
                address = parseInt(input, 16);
            } else if (/^[0-9A-Fa-f]+$/.test(input)) {
                address = parseInt(input, 16);
            } else {
                showStatus('‚ùå Formato inv√°lido. Usa 0xC000 o C000', 'error');
                return;
            }
            
            // Validar rango 16-bit
            if (isNaN(address) || address < 0 || address > 0xFFFF) {
                showStatus('‚ùå Direcci√≥n fuera de rango (0x0000-0xFFFF)', 'error');
                return;
            }
            
            currentLoadAddress = address;
            const addressHex = '0x' + address.toString(16).toUpperCase().padStart(4, '0');
            console.log(`üìç Direcci√≥n personalizada aplicada: ${addressHex} ‚Üí ${findMemorySlot(address)}`);
            showStatus(`‚úÖ Direcci√≥n: ${addressHex}`, 'success');
            hideStatusAfter(2000);
            
            if (currentRomData) {
                updateLoadInfo();
            }
        };

        // Funci√≥n para actualizar informaci√≥n de carga
        function updateLoadInfo() {
            if (!currentRomData) return;
            
            const binarySize = currentRomData.length;
            const startAddr = currentLoadAddress;
            const endAddr = currentLoadAddress + binarySize;
            const slot = findMemorySlot(startAddr);
            
            const loadPanel = document.getElementById('loadInfo');
            const addressEl = document.getElementById('loadAddress');
            const sizeEl = document.getElementById('loadSize');
            const endEl = document.getElementById('loadEndAddress');
            const slotEl = document.getElementById('loadSlot');
            
            addressEl.textContent = '0x' + startAddr.toString(16).toUpperCase().padStart(4, '0');
            sizeEl.textContent = formatBytes(binarySize) + ` (${binarySize} bytes)`;
            endEl.textContent = '0x' + Math.min(endAddr, 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
            slotEl.textContent = slot;
            
            // Cambiar color si sobrepasa el rango
            if (endAddr > 0x10000) {
                slotEl.style.color = '#ffaa00';
                slotEl.textContent += ' ‚ö†Ô∏è (Sobrepasa memoria)';
            } else {
                slotEl.style.color = 'var(--success)';
            }
            
            loadPanel.style.display = 'block';
            
            // Actualizar visualizaci√≥n del mapa de memoria
            drawMemoryMap();
        }

        // Funci√≥n para dibujar el mapa de memoria visualizado
        function drawMemoryMap() {
            if (!currentRomData) return;
            
            const container = document.getElementById('memoryPanel');
            let canvas = document.getElementById('memoryVisualCanvas');
            
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvas.id = 'memoryVisualCanvas';
                canvas.width = 280;
                canvas.height = 180;
                canvas.style.border = '1px solid rgba(0,255,65,0.3)';
                canvas.style.borderRadius = '4px';
                canvas.style.marginTop = '12px';
                canvas.style.marginBottom = '12px';
                
                const wrapper = document.createElement('div');
                wrapper.style.display = 'flex';
                wrapper.style.justifyContent = 'center';
                wrapper.appendChild(canvas);
                
                // Insertar despu√©s del info-content del mapa de memoria
                const infoContent = container.querySelector('.info-content');
                if (infoContent) {
                    infoContent.parentNode.insertBefore(wrapper, infoContent.nextSibling);
                }
            }
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Limpiar canvas
            ctx.fillStyle = '#000a1a';
            ctx.fillRect(0, 0, width, height);
            
            // Par√°metros de visualizaci√≥n
            const padding = 10;
            const barWidth = width - padding * 2;
            const barHeight = 25;
            const startY = padding;
            const slotHeight = (height - padding * 2) / 4;
            
            // Colores para diferentes regiones
            const slotColors = {
                'ROM': '#333366',
                'Cartridge': '#663366',
                'RAM': '#336699'
            };
            
            // Dibujar cada slot
            let y = startY;
            for (let [key, slot] of Object.entries(memoryMap)) {
                const x = padding;
                const slotBarHeight = 30;
                
                // Fondo del slot
                ctx.fillStyle = slotColors[slot.name.includes('ROM') ? 'ROM' : slot.name.includes('Cartridge') ? 'Cartridge' : 'RAM'];
                ctx.globalAlpha = 0.3;
                ctx.fillRect(x, y, barWidth, slotBarHeight);
                ctx.globalAlpha = 1.0;
                
                // Borde del slot
                ctx.strokeStyle = 'rgba(0,255,65,0.3)';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, barWidth, slotBarHeight);
                
                // Texto del slot
                ctx.fillStyle = 'rgba(0,255,65,0.7)';
                ctx.font = '10px monospace';
                ctx.textAlign = 'left';
                ctx.fillText(`0x${slot.address.toString(16).toUpperCase().padStart(4, '0')}-0x${(slot.address + slot.size - 1).toString(16).toUpperCase().padStart(4, '0')} ${slot.name}`, x + 4, y + 12);
                
                // Dibujar la ubicaci√≥n del binario si cae en este slot
                const binaryStart = currentLoadAddress;
                const binaryEnd = binaryStart + currentRomData.length;
                
                if (binaryStart < slot.address + slot.size && binaryEnd > slot.address) {
                    // Calcular posici√≥n relativa
                    const relStart = Math.max(0, binaryStart - slot.address);
                    const relEnd = Math.min(slot.size, binaryEnd - slot.address);
                    const pixelStart = (relStart / slot.size) * barWidth;
                    const pixelWidth = ((relEnd - relStart) / slot.size) * barWidth;
                    
                    // Dibujar binario
                    ctx.fillStyle = '#00ff41';
                    ctx.globalAlpha = 0.8;
                    ctx.fillRect(x + pixelStart, y + 2, pixelWidth, slotBarHeight - 4);
                    ctx.globalAlpha = 1.0;
                    
                    // Borde destacado
                    ctx.strokeStyle = '#00ff41';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x + pixelStart, y + 2, pixelWidth, slotBarHeight - 4);
                }
                
                y += slotHeight;
            }
            
            // Leyenda
            ctx.fillStyle = 'rgba(0,255,65,0.6)';
            ctx.font = '9px monospace';
            ctx.textAlign = 'left';
            ctx.fillText('‚ñ† Verde = Binario cargado', padding, height - 5);
        }

        document.getElementById('clearBtn').addEventListener('click', () => {
            currentRomData = null;
            fileInput.value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('analysisPanel').style.display = 'none';
            document.getElementById('memoryPanel').style.display = 'none';
            document.getElementById('zipBlocksPanel').style.display = 'none';
            document.getElementById('loadInfo').style.display = 'none';
            document.getElementById('clearBtn').style.display = 'none';
            document.getElementById('canvasContainer').innerHTML = `
                <div class="canvas-placeholder">
                    <p>üìÇ Carga un archivo ROM</p>
                    <p style="font-size: 0.85em; margin-top: 10px; color: var(--text-secondary);">
                        o arrastra un archivo .rom aqu√≠
                    </p>
                </div>
            `;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processFullBtn').disabled = true;
            hideStatus();
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PANEL AVANZADO: OPCIONES DE OFFSET Y TAMA√ëO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Toggle del panel avanzado
        document.getElementById('advToggle').addEventListener('click', () => {
            const content = document.getElementById('advContent');
            const icon = document.getElementById('advToggleIcon');
            content.classList.toggle('active');
            icon.textContent = content.classList.contains('active') ? '‚ñ≤' : '‚ñº';
        });

        // Funci√≥n para establecer presets
        window.setRomPreset = function(offset, size) {
            document.getElementById('romOffset').value = offset;
            document.getElementById('romSize').value = size;
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INICIAR APLICACI√ìN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        console.log('üöÄ Iniciando MSX2 ROM Viewer v1.0');
        console.log('¬© 2026 PAPIWEB DESARROLLOS INFORMATICOS');
        initializeWasm();
    </script>

    <!-- Emulator Script - WebMSX Integration -->
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EMULADOR MSX2 REAL (Z80 + VDP) 
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        /** Clase VDP - Video Display Processor Yamaha V9938 */
        class VDP {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.width = 256;
                this.height = 212;
                this.scanline = 0;
                this.frameCount = 0;
                
                // Registros VDP (32 registros)
                this.registers = new Uint8Array(32);
                this.statusRegister = 0;
                
                // VRAM - 128KB Memory
                this.vram = new Uint8Array(128 * 1024);
                
                // Paleta de 256 colores
                this.palette = new Uint32Array(256);
                this.initializePalette();
                
                // Buffer de video
                this.frameBuffer = new Uint8ClampedArray(this.width * this.height * 4);
                this.imageData = this.ctx.createImageData(this.width, this.height);
                
                console.log('‚úÖ VDP Inicializado (128KB VRAM, Paleta 256 colores)');
            }
            
            initializePalette() {
                // Paleta MSX2 est√°ndar (16 colores base expandido a 256)
                const basePalette = [
                    0xFF000000, 0xFF000000, 0xFF118650, 0xFF3CB371,
                    0xFF0E235F, 0xFF0E8FD7, 0xFFC80000, 0xFF00BFFF,
                    0xFFFF0000, 0xFFFF6B6B, 0xFFCCCC00, 0xFFFFFF00,
                    0xFF008C00, 0xFFCC66CC, 0xFFCCCCCC, 0xFFFFFFFF
                ];
                
                // Llenar los 256 colores
                for (let i = 0; i < 256; i++) {
                    this.palette[i] = basePalette[i % 16];
                }
            }
            
            // Escribir en VRAM
            writeVRAM(addr, value) {
                if (addr < this.vram.length) {
                    this.vram[addr] = value;
                }
            }
            
            // Leer VRAM
            readVRAM(addr) {
                if (addr < this.vram.length) {
                    return this.vram[addr];
                }
                return 0;
            }
            
            // Escribir registro VDP
            writeRegister(reg, value) {
                if (reg < 32) {
                    this.registers[reg] = value;
                    console.log(`üìù VDP Registro #${reg} = 0x${value.toString(16).padStart(2, '0')}`);
                }
            }
            
            // Leer estado
            readStatus() {
                return this.statusRegister;
            }
            
            // Renderizar frame
            render(romData) {
                const data = this.frameBuffer;
                let pixelIdx = 0;
                
                // Extraer patr√≥n visual de VRAM o ROM seg√∫n modo
                for (let y = 0; y < this.height; y++) {
                    for (let x = 0; x < this.width; x++) {
                        // Direcci√≥n VRAM o ROM
                        const addr = (y * this.width + x) % Math.min(this.vram.length, romData.length);
                        const vramAddr = (y * 128 + x / 2) % this.vram.length;
                        
                        // Usar VRAM si contiene datos, sino usar ROM
                        let byte = this.vram[vramAddr] || romData[addr] || 0;
                        
                        // Extraer nibble (4 bits = un color √≠ndice)
                        const colorIdx = (byte >> ((x & 1) ? 0 : 4)) & 0x0F;
                        const rgbColor = this.palette[colorIdx];
                        
                        // Convertir ARGB a RGBA
                        data[pixelIdx] = (rgbColor >> 16) & 0xFF;      // R
                        data[pixelIdx + 1] = (rgbColor >> 8) & 0xFF;   // G
                        data[pixelIdx + 2] = rgbColor & 0xFF;          // B
                        data[pixelIdx + 3] = 255;                      // A
                        
                        pixelIdx += 4;
                    }
                }
                
                // Actualizar canvas
                this.imageData.data.set(data);
                this.ctx.putImageData(this.imageData, 0, 0);
                this.frameCount++;
                this.statusRegister = (this.statusRegister + 1) & 0xFF;
            }
        }

        /** Clase CPU Z80 - Minimal Simulator */
        class Z80 {
            constructor(vdp, memory) {
                this.vdp = vdp;
                this.memory = memory;
                this.pc = 0;        // Program Counter
                this.sp = 0xFFFF;   // Stack Pointer
                this.af = 0;        // Acumulador y Flags
                this.bc = 0;        // B y C
                this.de = 0;        // D y E
                this.hl = 0;        // H y L
                this.cycleCount = 0;
                this.running = false;
                
                console.log('‚úÖ Z80 CPU Inicializado (@ 3.57MHz)');
            }
            
            reset() {
                this.pc = 0;
                this.sp = 0xFFFF;
                this.cycleCount = 0;
                console.log('üîÑ Z80 CPU Reset');
            }
            
            step() {
                // Ciclo simplificado del CPU
                if (this.pc < this.memory.length) {
                    const opcode = this.memory[this.pc];
                    this.pc = (this.pc + 1) & 0xFFFF;
                    this.cycleCount += 4;
                }
            }
            
            run(cycles) {
                while (this.cycleCount < cycles && this.running) {
                    this.step();
                }
            }
        }

        /** Clase MSX2 Machine */
        class MSX2Machine {
            constructor(canvas) {
                this.vdp = new VDP(canvas);
                this.romBuffer = null;
                
                // Memoria MSX2 (64KB de RAM)
                this.ram = new Uint8Array(64 * 1024);
                this.cpu = new Z80(this.vdp, this.ram);
                
                this.running = false;
                this.frameId = null;
                this.frameRate = 1000 / 60;  // ~60 FPS
                
                console.log('‚úÖ M√°quina MSX2 Inicializada (64KB RAM + VDP)');
            }
            
            loadROM(romData) {
                this.romBuffer = new Uint8Array(romData);
                // Cargar ROM en VRAM
                for (let i = 0; i < Math.min(romData.length, this.vdp.vram.length); i++) {
                    this.vdp.vram[i] = romData[i];
                }
                console.log(`üìÇ ROM cargada: ${romData.length} bytes en VRAM`);
            }
            
            start() {
                if (!this.romBuffer) {
                    console.error('‚ùå Sin ROM cargada');
                    return;
                }
                
                this.running = true;
                this.cycle();
                console.log('üéÆ MSX2 Iniciado - Emulaci√≥n en progreso');
            }
            
            cycle() {
                if (!this.running) return;
                
                // Ejecutar ciclo CPU (aproximadamente 3.57MHz)
                this.cpu.running = true;
                this.cpu.run(3570 / 60);  // Ciclos por frame @ 60 FPS
                
                // Renderizar frame VDP
                this.vdp.render(this.romBuffer);
                
                this.frameId = requestAnimationFrame(() => this.cycle());
            }
            
            pause() {
                this.running = false;
                if (this.frameId) {
                    cancelAnimationFrame(this.frameId);
                }
                console.log('‚è∏Ô∏è MSX2 En pausa');
            }
            
            stop() {
                this.running = false;
                if (this.frameId) {
                    cancelAnimationFrame(this.frameId);
                }
                this.cpu.reset();
                this.romBuffer = null;
                console.log('‚èπÔ∏è MSX2 Detenido');
            }
            
            reset() {
                this.cpu.reset();
                this.vdp.frameCount = 0;
                console.log('üîÑ MSX2 Reset');
            }
        }

        let jsmsxInstance = null;
        let jsmsxROMBuffer = null;
        let jsmsxRunning = false;
        let emulationFrameId = null;

        // Inicializar emulador
        async function loadJSMSX() {
            try {
                console.log('üì¶ Cargando emulador MSX2 con Z80...');
                
                const container = document.getElementById('canvas-container');
                const canvas = document.createElement('canvas');
                canvas.id = 'jsmsx-canvas';
                canvas.width = 256;
                canvas.height = 212;
                canvas.style.border = '2px solid var(--primary)';
                canvas.style.imageRendering = 'pixelated';
                canvas.style.display = 'block';
                canvas.style.margin = '0 auto';
                canvas.style.transform = 'scale(2)';
                canvas.style.transformOrigin = 'top center';
                
                container.innerHTML = '';
                container.appendChild(canvas);
                
                // Crear instancia MSX2
                jsmsxInstance = new MSX2Machine(canvas);
                
                console.log('‚úÖ Emulador MSX2 listo (Z80 + VDP + 64KB RAM)');
                return true;
            } catch (err) {
                console.error('‚ùå Error cargando emulador:', err);
                return false;
            }
        }

        // Cargar ROM (con soporte para ZIP)
        document.getElementById('jsmsx-romInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (evt) => {
                const data = new Uint8Array(evt.target.result);
                
                // Detectar si es ZIP (firma magic: 0x504B0304)
                const isZip = data[0] === 0x50 && data[1] === 0x4B && data[2] === 0x03 && data[3] === 0x04;
                
                if (isZip) {
                    console.log('üì¶ Archivo ZIP detectado en emulador, procesando bloques...');
                    handleEmulatorZipFile(file, data);
                } else {
                    jsmsxROMBuffer = data;
                    console.log(`üìÇ ROM cargada: ${file.name} (${jsmsxROMBuffer.length} bytes)`);
                    console.log('‚úÖ Lista para reproducir - Presiona "Iniciar"');
                    document.getElementById('jsmsx-zipBlocksPanel').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        });
        async function handleEmulatorZipFile(file, zipData) {
            try {
                console.log('üóúÔ∏è Descomprimiendo ZIP del emulador...');
                
                const zip = new JSZip();
                await zip.loadAsync(zipData);
                
                const files = [];
                
                // Recolectar todos los archivos del ZIP
                zip.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir) {
                        files.push({
                            name: relativePath,
                            size: zipEntry._data ? zipEntry._data.uncompressedSize : 0,
                            path: relativePath
                        });
                    }
                });
                
                if (files.length === 0) {
                    console.error('‚ùå No hay archivos en el ZIP del emulador');
                    return;
                }
                
                console.log(`üì¶ ZIP contiene ${files.length} archivo(s):`, files);
                displayEmulatorZipBlocksPanel(file, zip, files);
                
            } catch (err) {
                console.error('‚ùå Error descomprimiendo ZIP del emulador:', err);
            }
        }

        function displayEmulatorZipBlocksPanel(file, zip, files) {
            const blocksPanel = document.getElementById('jsmsx-zipBlocksPanel');
            const blocksList = document.getElementById('jsmsx-zipBlocksList');
            
            blocksList.innerHTML = '';
            
            files.forEach((fileInfo) => {
                const btn = document.createElement('button');
                btn.className = 'zip-block-button';
                btn.innerHTML = `
                    <span>üìÑ ${fileInfo.name}</span>
                    <span class="zip-block-size">${formatBytes(fileInfo.size)}</span>
                `;
                
                btn.addEventListener('click', async () => {
                    // Marcar como seleccionado
                    document.querySelectorAll('#jsmsx-zipBlocksList .zip-block-button').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    try {
                        console.log(`‚è≥ Extrayendo ${fileInfo.name} para emulador...`);
                        
                        // Extraer el archivo del ZIP
                        const extractedData = await zip.file(fileInfo.path).async('uint8array');
                        jsmsxROMBuffer = extractedData;
                        
                        console.log(`‚úÖ ${fileInfo.name} cargado en emulador (${formatBytes(extractedData.length)})`);
                        console.log('‚úÖ Lista para reproducir - Presiona "Iniciar"');
                        
                    } catch (err) {
                        console.error('‚ùå Error extrayendo archivo del ZIP:', err);
                    }
                });
                
                blocksList.appendChild(btn);
            });
            
            blocksPanel.style.display = 'block';
        }

        // Controles del Emulador
        window.jsmsx_play = async () => {
            if (!jsmsxROMBuffer) {
                alert('Por favor carga una ROM primero');
                return;
            }

            if (!jsmsxInstance) {
                const ready = await loadJSMSX();
                if (!ready) {
                    alert('Error al inicializar emulador');
                    return;
                }
            }

            // Cargar ROM en la m√°quina
            jsmsxInstance.loadROM(jsmsxROMBuffer);
            jsmsxInstance.start();
            jsmsxRunning = true;
        };

        window.jsmsx_pause = () => {
            if (jsmsxInstance) {
                jsmsxInstance.pause();
                jsmsxRunning = false;
                console.log('‚è∏Ô∏è Emulador en pausa');
            }
        };

        window.jsmsx_stop = () => {
            if (jsmsxInstance) {
                jsmsxInstance.stop();
            }
            jsmsxRunning = false;
            jsmsxROMBuffer = null;
            document.getElementById('jsmsx-romInput').value = '';
            document.getElementById('jsmsx-zipBlocksPanel').style.display = 'none';
            console.log('‚èπÔ∏è Emulador detenido');
        };

        window.jsmsx_reset = () => {
            if (jsmsxInstance) {
                jsmsxInstance.reset();
                console.log('üîÑ Emulador reset');
            }
        };

        // Mapeo de teclas
        const keyMap = {
            'arrowup': 0,
            'arrowdown': 1,
            'arrowleft': 2,
            'arrowright': 3,
            ' ': 4,
            'z': 5,
            'control': 6,
            'enter': 7,
        };

        document.addEventListener('keydown', (e) => {
            if (!jsmsxRunning) return;
            
            const key = e.key.toLowerCase();
            if (key === 'escape') {
                jsmsx_pause();
            }
        });

        // Pantalla completa
        document.getElementById('jsmsx-fullscreen').addEventListener('change', (e) => {
            const container = document.getElementById('jsmsx-container');
            if (e.target.checked) {
                container.requestFullscreen?.();
            } else {
                document.exitFullscreen?.();
            }
        });

        // Inicializar emulador al cargar
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üéÆ Emulador MSX2 (Z80 + Yamaha V9938 VDP) listo');
            console.log('üíæ Carga una ROM y presiona Iniciar para jugar');
            console.log('üìä Resoluci√≥n: 256√ó212 | Frecuencia CPU: 3.57MHz | FPS: 60');
        });
    </script>
</body>
</html>
